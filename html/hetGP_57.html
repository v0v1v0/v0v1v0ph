<div class="container">

<table style="width: 100%;"><tr>
<td>simul.CRNGP</td>
<td style="text-align: right;">R Documentation</td>
</tr></table>
<h2>Fast conditional simulation for a CRNGP model</h2>

<h3>Description</h3>

<p>Fast conditional simulation for a CRNGP model
</p>


<h3>Usage</h3>

<pre><code class="language-R">## S3 method for class 'CRNGP'
simul(
  object,
  Xgrid,
  ids = NULL,
  nsim = 1,
  eps = sqrt(.Machine$double.eps),
  seqseeds = TRUE,
  check = TRUE
)
</code></pre>


<h3>Arguments</h3>

<table>
<tr style="vertical-align: top;">
<td><code>object</code></td>
<td>
<p>a <code>CRNGP</code> model obtained with <code>mleCRNGP</code></p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>Xgrid</code></td>
<td>
<p>matrix of (x, seed) locations where the simulation is performed.
The last column MUST correspond to seeds values. <code>Xgrid</code> must also contain the evaluated designs (e.g., in <code>object$X0</code>).
All design locations are matched with all seed values, either by increasing seed values or repeating the seed sequence.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>ids</code></td>
<td>
<p>vector of indices corresponding to observed values in <code>Xgrid</code></p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>nsim</code></td>
<td>
<p>number of simulations to return</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>eps</code></td>
<td>
<p>jitter used in the Cholesky decomposition of the covariance matrix for numerical stability</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>seqseeds</code></td>
<td>
<p>is the seed sequence repeated (e.g., 1 2 3 1 2 3), else it is assumed to be ordered (e.g., 1 1 2 2 3 3)</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>check</code></td>
<td>
<p>if <code>TRUE</code>, check that <code>Xgrid</code> has the proper structure (slower)</p>
</td>
</tr>
</table>
<h3>Value</h3>

<p>A matrix of size <code>nrow(Xgrid) x nsim</code>.
</p>


<h3>References</h3>

<p>Chiles, J. P., &amp; Delfiner, P. (2012). Geostatistics: modeling spatial uncertainty (Vol. 713). John Wiley &amp; Sons. <br><br></p>
<p>Chevalier, C.; Emery, X.; Ginsbourger, D.
Fast Update of Conditional Simulation Ensembles
Mathematical Geosciences, 2014
</p>


<h3>Examples</h3>

<pre><code class="language-R">## Not run: 
##------------------------------------------------------------
## Example: Homoskedastic GP modeling on 2d sims
##------------------------------------------------------------
set.seed(2)
nx &lt;- 31
ns &lt;- 5
d &lt;- 2
x &lt;- as.matrix(expand.grid(seq(0,1, length.out = nx), seq(0,1, length.out = nx)))
s &lt;- matrix(seq(1, ns, length.out = ns))
Xgrid &lt;- as.matrix(expand.grid(seq(1, ns, length.out = ns), seq(0,1, length.out = nx), 
                               seq(0,1, length.out = nx)))
Xgrid &lt;- Xgrid[,c(2, 3, 1)]
g &lt;- 1e-6
theta &lt;- c(0.2, 0.5)
KX &lt;- cov_gen(x, theta = theta)
rho &lt;- 0.33
KS &lt;- matrix(rho, ns, ns)
diag(KS) &lt;- 1

YY &lt;- MASS::mvrnorm(n = 1, mu = rep(0, nx*nx*ns), Sigma = kronecker(KX, KS) + g * diag(nx*nx*ns))
YYmat &lt;- matrix(YY, ns, nx*nx)
filled.contour(matrix(YYmat[1,], nx))
filled.contour(matrix(YYmat[2,], nx))

ids &lt;- sample(1:nrow(Xgrid), 80)
X0 &lt;- Xgrid[ids,]
Y0 &lt;-  YY[ids]

# For 3d visualization
# library(rgl)
# plot3d(Xgrid[,1], Xgrid[,2], YY, col = 1 + (Xgrid[,3] - 1) %% 6)
# points3d(X0[,1], X0[,2], Y0, size = 10, col = 1 + ((X0[,3] - 1) %% 6))

model &lt;- mleCRNGP(X0, Y0, known = list(g = 1e-6))

preds &lt;- predict(model, x = Xgrid, xprime = Xgrid)
# surface3d(unique(Xgrid[1:nx^2,1]),unique(Xgrid[,2]), matrix(YY[Xgrid[,3]==1], nx), 
#   front = "lines", back = "lines")
# aspect3d(1, 1, 1)
# surface3d(unique(Xgrid[1:nx^2,1]),unique(Xgrid[,2]), matrix(preds$mean[Xgrid[,3]==1], nx), 
#   front = "lines", back = "lines", col = "red")

# Conditional realizations (classical way)
set.seed(2)
t0 &lt;- Sys.time()
SigmaCond &lt;- 1/2 * (preds$cov + t(preds$cov))
sims &lt;- t(chol(SigmaCond + diag(sqrt(.Machine$double.eps), nrow(Xgrid)))) %*% rnorm(nrow(Xgrid))
sims &lt;- sims + preds$mean
print(difftime(Sys.time(), t0))
# sims &lt;- MASS::mvrnorm(n = 1, mu = preds$mean, Sigma = 1/2 * (preds$cov + t(preds$cov)))
# plot3d(X0[,1], X0[,2], Y0, size = 10, col = 1 + ((X0[,3] - 1) %% 6))
# surface3d(unique(x[,1]), unique(x[,2]), matrix(sims[Xgrid[,3] == 1], nx), col = 1, 
#   front = "lines", back = "lines")
# surface3d(unique(x[,1]), unique(x[,2]), matrix(sims[Xgrid[,3] == 2], nx), col = 2, 
#   front = "lines", back = "lines")

# Alternative for conditional realizations 
# (note: here the design points are part of the simulation points)
set.seed(2)
t0 &lt;- Sys.time()
condreas &lt;- simul(model, Xgrid, ids = ids)
print(difftime(Sys.time(), t0))
# plot3d(X0[,1], X0[,2], Y0, size = 10, col = 1 + ((X0[,3] - 1) %% 6))
# surface3d(unique(x[,1]), unique(x[,2]), matrix(condreas[Xgrid[,3] == 1], nx), col = 1, 
#   front = "lines", back = "lines")
# surface3d(unique(x[,1]), unique(x[,2]), matrix(condreas[Xgrid[,3] == 2], nx), col = 2, 
#   front = "lines", back = "lines")

# Alternative using ordered seeds:
Xgrid2 &lt;- as.matrix(expand.grid(seq(0,1, length.out = nx), 
  seq(0,1, length.out = nx), seq(1, ns, length.out = ns)))
condreas2 &lt;- simul(model, Xgrid2, ids = ids, seqseeds = FALSE)

## Check that values at X0 are coherent:
# condreas[ids,1] - Y0
# sims[ids,1] - Y0

## Check that the empirical mean/covariance is correct
condreas2 &lt;- simul(model, Xgrid, ids = ids, nsim = 1000)
print(range(rowMeans(condreas2) - preds$mean))
print(range(cov(t(condreas2)) - preds$cov))

## End(Not run)
</code></pre>


</div>